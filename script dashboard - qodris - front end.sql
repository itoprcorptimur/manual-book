declare @branch char(6),@tanggal char(8),@sales char(8) ,@periode char(6),@tgl char(2) ,@sql varchar(4000),@i int,@j int select @branch='CSADEV',@tanggal='20181115',@sales='SMRSR003' select @periode=left(ltrim(@tanggal),6),@tgl=right(rtrim(@tanggal),2),@i=1 set @j=cast(@tgl as int) set @sql=' select x.fc_sales ,coverage_toko=SUM(x.coverage_toko) ,mtd_plan=SUM(x.mtd_plan) ,mtd_visit=SUM(x.mtd_visit) ,[call]=case when SUM(x.mtd_plan)=0 then 0 else cast(round(cast(SUM(x.mtd_visit) as numeric(18,2))/cast(SUM(x.mtd_plan) as numeric(18,2))*100,2) as numeric(18,2)) end ,mtd_order=SUM(x.mtd_order) ,ec=case when SUM(x.mtd_visit)=0 then 0 else cast(round(cast(SUM(x.mtd_order) as numeric(18,2))/cast(SUM(x.mtd_visit) as numeric(18,2))*100,2) as numeric(18,2)) end ,[target]=SUM(x.[target]) ,actual=SUM(x.actual) ,ach=SUM(x.ach) from( select a.fc_sales,coverage_toko=0,mtd_plan=0,mtd_visit=0,mtd_order=0 ,[target]=cast(isnull(sum(b.fm_value),0) as numeric(18,2)) ,actual=cast(isnull(sum(d.realisasi),0) as numeric(18,2)) ,ach=case when sum(cast(isnull(b.fm_value,0) as numeric(18,2)))=0 or isnull( sum(d.realisasi),0)=0 then 0 else cast(isnull(((sum(d.realisasi)/sum(cast(isnull(b.fm_value,0) as numeric(18,2))))*100),0) as numeric(18,2)) end from d_master..t_incentive_sales_team a with(nolock) left join d_master..t_salesforce_brandgroup b with(nolock) on a.fc_branch=b.fc_branch and a.fc_periode=b.fc_periode and a.fc_sales=b.fc_sales left join d_master..t_incentive_prinsipal c with(nolock) on b.fc_branch=c.fc_branch and b.fc_sales=c.FC_SALES and b.fc_brand=c.FC_BRAND and b.fc_group=c.FC_GROUP left outer join ( select x.FC_BRANCH,x.FC_PERIODE,x.FC_KODE,z.fc_kodeprinsipal,z.fc_nbrand,z.fc_ngroup,SUM(FM_OT_VALINV) realisasi from D_TRANSAKSI..t_trxhpp x with(nolock) inner join d_master..t_customer y with(nolock) on x.FC_BRANCH=y.FC_BRANCH and x.FC_KODE=y.FC_CUSTCODE inner join d_master..t_stockparam z with(nolock) on x.FC_BRANCH=z.fc_branch and x.FC_STOCKCODE=z.fc_stockcode where x.FC_BRANCH='''+@branch+''' and x.FC_PERIODE='''+@periode+''' and x.FC_TRXTYPE IN (''OA'',''OB'',''OE'',''CN'',''DN'',''O3'') and y.FC_CUSTTYPE NOT IN (''CB'',''HM'',''DE'') and (z.fc_kodeprinsipal is not null or z.fc_nbrand is not null or z.fc_ngroup is not null) group by x.FC_BRANCH,x.FC_PERIODE,x.FC_KODE,z.fc_kodeprinsipal,z.fc_nbrand,z.fc_ngroup ) d on a.FC_BRANCH=d.fc_branch and a.fc_periode=d.fc_periode and b.fc_custcode=d.FC_KODE and LEFT(b.fc_brand,6)=ltrim(d.fc_kodeprinsipal) and SUBSTRING(b.fc_brand,7,2)=ltrim(d.fc_nbrand) and b.fc_group=ltrim(d.fc_ngroup) where a.fc_branch='''+@branch+''' and a.fc_periode='''+@periode+''' and a.fc_sales='''+@sales+''' group by a.fc_sales union select fc_sales,coverage_toko=count(distinct fc_custcode) ,mtd_plan=0,mtd_visit=0,mtd_order=0,[target]=0,actual=0,ach=0 from D_MASTER..t_salesforce_visit where fc_branch='''+@branch+''' and fc_periode='''+@periode+''' and fc_sales='''+@sales+''' group by fc_sales union select fc_sales,coverage_toko=0,mtd_plan=count(distinct fc_custcode) ,mtd_visit=0,mtd_order=0,[target]=0,actual=0,ach=0 from D_MASTER..t_salesforce_visit where fc_branch='''+@branch+''' and fc_periode='''+@periode+''' and fc_sales='''+@sales+''' ' while @i<=@j begin if @i=1 set @sql=@sql+' and (fd_01>0' else if @i between 2 and 9 set @sql=@sql+' or fd_0'+rtrim(ltrim(str(@i)))+'>0' else if @i between 10 and 31 set @sql=@sql+' or fd_'+rtrim(ltrim(str(@i)))+'>0' if @i=@j set @sql=@sql+')' set @i+=1 end set @sql=@sql+' group by fc_sales union select fc_sales,coverage_toko=0,mtd_plan=0,mtd_visit=count(distinct fc_custcode) ,mtd_order=0,[target]=0,actual=0,ach=0 from D_SFA..t_salesvisit_log where fc_branch='''+@branch+''' and convert(char(8),convert(date,fd_trxdate,121),112)between '''+@periode+'01'' and'''+@tanggal+''' and fc_sales='''+@sales+''' and isnull(fn_visit,0)>0 group by fc_sales union select fc_sales,coverage_toko=0,mtd_plan=0,mtd_visit=0,mtd_order=count(distinct fc_custcode) ,[target]=0,actual=0,ach=0 from D_SFA..t_salesvisit_log where fc_branch='''+@branch+''' and convert(char(8),convert(date,fd_trxdate,121),112)between '''+@periode+'01'' and'''+@tanggal+''' and fc_sales='''+@sales+''' and isnull(fn_order,0)>0 group by fc_sales )x group by x.fc_sales' exec (@sql)